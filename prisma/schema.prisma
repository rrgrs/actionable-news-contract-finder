// Prisma schema for Actionable News Contract Finder
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

/// News processing pipeline status
enum NewsStatus {
  PENDING   // Just fetched, needs embedding
  EMBEDDED  // Has embedding, needs market matching
  MATCHED   // Matched with markets, needs LLM validation
  VALIDATED // LLM validated, processing complete
  FAILED    // Processing failed (will retry)
}

/// News articles fetched from various sources
model NewsArticle {
  id               Int         @id @default(autoincrement())
  externalId       String      @unique @map("external_id") // Original ID from news source
  source           String      // e.g., "reddit-news", "rss-aggregator", "gdelt-news"
  title            String
  content          String?
  summary          String?
  url              String?
  author           String?
  publishedAt      DateTime    @map("published_at")
  tags             String[]    @default([])
  metadata         Json?       // Source-specific metadata

  // Processing pipeline status
  status           NewsStatus  @default(PENDING)
  errorMessage     String?     @map("error_message") // Error details if FAILED

  // Embedding for matching against markets (768-dim vector)
  embedding        Unsupported("vector(768)")?
  embeddedAt       DateTime?   @map("embedded_at")

  // Timestamps
  fetchedAt        DateTime    @default(now()) @map("fetched_at")
  matchedAt        DateTime?   @map("matched_at")
  validatedAt      DateTime?   @map("validated_at")

  // Relations
  marketMatches    NewsMarketMatch[]

  @@index([status])
  @@index([source])
  @@index([fetchedAt])
  @@map("news_articles")
}

/// Stores matches between news articles and markets (before LLM validation)
model NewsMarketMatch {
  id                Int           @id @default(autoincrement())
  newsArticleId     Int           @map("news_article_id")
  marketId          Int           @map("market_id")

  // Embedding similarity score
  similarity        Float

  // LLM validation results (null until validated)
  isValidated       Boolean       @default(false) @map("is_validated")
  isRelevant        Boolean?      @map("is_relevant")
  relevanceScore    Float?        @map("relevance_score")
  confidence        Float?
  suggestedPosition String?       @map("suggested_position") // 'buy' | 'sell' | 'hold'
  reasoning         String?

  // Alert tracking
  alertSent         Boolean       @default(false) @map("alert_sent")
  alertSentAt       DateTime?     @map("alert_sent_at")

  createdAt         DateTime      @default(now()) @map("created_at")
  validatedAt       DateTime?     @map("validated_at")

  newsArticle       NewsArticle   @relation(fields: [newsArticleId], references: [id], onDelete: Cascade)
  market            Market        @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([newsArticleId, marketId])
  @@index([newsArticleId])
  @@index([marketId])
  @@index([isValidated])
  @@index([alertSent])
  @@map("news_market_matches")
}

/// Market represents a prediction market question/event with multiple betting options
model Market {
  id                 Int        @id @default(autoincrement())
  platform           String
  eventTicker        String     @map("event_ticker") // Platform-specific grouping key (e.g., "KXSPOTIFY2D")
  seriesTicker       String?    @map("series_ticker") // Higher-level grouping (e.g., "KXSPOTIFY")
  title              String // The market question
  url                String
  category           String?
  endDate            DateTime?  @map("end_date")
  isActive           Boolean    @default(true) @map("is_active")

  // Embedding for semantic matching (at market level) - 768-dim vector
  embedding          Unsupported("vector(768)")?
  embeddingUpdatedAt DateTime?  @map("embedding_updated_at")

  // Timestamps
  lastSyncedAt       DateTime   @default(now()) @map("last_synced_at")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  // Relations
  contracts   Contract[]
  newsMatches NewsMarketMatch[]

  @@unique([platform, eventTicker])
  @@index([platform])
  @@index([isActive])
  @@map("markets")
}

/// Contract represents an individual betting option within a Market
model Contract {
  id             Int      @id @default(autoincrement())
  marketId       Int      @map("market_id")
  contractTicker String   @map("contract_ticker") // Platform's unique ID (e.g., "KXBTC-26JAN0109-T97749.99")
  title          String   // The betting option (e.g., "Bitcoin above $97,750")

  // Pricing
  yesPrice       Float    @default(0) @map("yes_price")
  noPrice        Float    @default(0) @map("no_price")
  volume         Float    @default(0)
  liquidity      Float    @default(0)

  // Metadata (platform-specific details - non-redundant fields only)
  metadata       String?
  isActive       Boolean  @default(true) @map("is_active")

  // Timestamps
  lastSyncedAt   DateTime @default(now()) @map("last_synced_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([contractTicker])
  @@index([marketId])
  @@index([isActive])
  @@map("contracts")
}
